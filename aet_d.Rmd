---
title: "aet v d"
author: "Janelle Christensen"
date: "2/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# 2/4/21
# Janele Christensen
# AET v. D climate future plots


# ------------------------
# attach packages
# ------------------------

library(tidyverse)
library(data.table)
library(here)
library(lubridate)
library(beepr)
library(httr)
```


```{r}
# -----------------------
# initialize variables
# -----------------------

site = "little_saddle_mtn" 

lat = 44.702 

lon = -110.018 

hist_start = 1980 

hist_end = 2010

future_center = 2040

future_timespan = 30 #how many years do you want to average your future data on?

future_start = future_center - (future_timespan / 2)

future_end = future_center + (future_timespan / 2)

aet_d_past <-  !file.exists(here::here("sites", 
                                  site, 
                                  "raw_data", 
                                  paste("lat_", lat, "_lon_", lon, sep = ""),
                                  "historical_aet_d.csv"))

#suggest at least 30 yr chunk of time for both future and past
```

# Download Data

```{r, eval = aet_d_past}
# average of years in the past, average of years in the future

# -----------------------
# past data
# -----------------------

#initialize some variables to hold data 

holder <- NULL 

mydat <- NULL 

mydat2 <- NULL 

mydat3 <- NULL 

#This is the loop that runs across all the climate variables you want to download 

for(climvar in c("Deficit_monthly", "AET_monthly")){ 
  
  print(paste("downloading",climvar, "historical"))#this is a progress update as the loop runs 
  
  
  #the url uses two variable names for same variable in monthly download string like "PET_monthly" for long name and "pet" for short name 
  
  #the short name is sometimes a different case than the long variable name, so make it lowercase so that 
  
  #url string will work with the format of data stored on the cloud 
  
  varshort<-unlist(strsplit(climvar,"_m"));varshort 
  
  vshort<-varshort[[1]];vshort
  
  if(vshort=="Deficit"){#change case of short name from upper to lower case 
    
    vshort<-"deficit" 
    
  };vshort 
  
  
  if(vshort=="AET"){ 
    
    vshort<-"aet" 
    
  };vshort 
  
  for(yr in c(hist_start:hist_end)){# for each climate variable loop across the year.  allows users to select range if not interested in all data 
    
    #Specify URL where are stored on cloud 
    
    #single variable single year monthly time series with variable and year specified by user 
    
      data_url<-paste("http://www.yellowstone.solutions/thredds/ncss/daily_or_monthly/v2_historical/monthly/v2_",yr,"_",climvar,".nc4?var=",vshort,"&latitude=",lat,"&longitude=",lon,"&time_start=1980-01-16T05%3A14%3A31.916Z&time_end=1980-12-16T00%3A34%3A14.059Z&accept=csv_file",sep ="") 
    
    
    holder <-data.frame(fread(data_url, 
                              verbose=FALSE, 
                              showProgress = FALSE,
    ))#temporary holder for subsets downloaded from cloud 
    
    mydat<-rbind(mydat, holder)#file that grows by adding each chunk downloaded from cloud 
    
  }#end loop across years 
  
  mydat2<-cbind(mydat2,mydat[,4])#append just the water balance data from each downloaded chunk 
  
  date <- mydat$time # date will download wrong
  
  mydat<-NULL#reset this variable so it can accodomate a new column name given the new water balance variable it's extracting at each loop cycle
  
  
}#end loop across climate variables 


mydat3<-cbind(date,holder[,2:3],mydat2)#join the data with meta data including date, lat, long 

colnames(mydat3)[]<-c("date", "lat","lon", "deficit_monthly", "aet_monthly") 

  divide.by.10 <- function(x, na.rm = FALSE) {
    x/10
  }
  
  mydat4 <- mydat3 %>% 
    mutate(lat = as.character(lat),
           lon = as.character(lon)) %>% 
    mutate_if(is.numeric, divide.by.10)
  
  write_csv(mydat4, here::here("sites",
                               site,
                               "raw_data",
                               paste("lat",lat,"lon",lon, sep = "_"),
                               "historical_aet_d.csv"))
  
beep(3)

```


```{r}

# -----------------------
# future data
# -----------------------

mydat7 <- NULL

climmodel <- c("inmcm4","NorESM1-M","MRI-CGCM3","MIROC5","IPSL-CM5A-LR","HadGEM2-CC365","GFDL-ESM2G","CanESM2","CSIRO-Mk3-6-0","CNRM-CM5","BNU-ESM")# climate model names
for(m in climmodel){ #open climmodel
  #initialize some variables to hold data 
  
 
  
  #This is the loop that runs across all the climate variables you want to download 
  
  for(rcp in c("rcp45", "rcp85")){
    
    holder <- NULL 
    
    mydat <- NULL 
    
    mydat2 <- NULL
    
    for(climvar in c("Deficit_monthly", "AET_monthly")){ #open climvar
    
    
    print(paste("downloading", climvar, rcp, m))#this is a progress update as the loop runs 
    
    
    #the url uses two variable names for same variable in monthly download string like "PET_monthly" for long name and "pet" for short name 
    
    #the short name is sometimes a different case than the long variable name, so make it lowercase so that 
    
    #url string will work with the format of data stored on the cloud 
    
    varshort<-unlist(strsplit(climvar,"_m"));varshort 
    
    vshort<-varshort[[1]];vshort 
    
    if(vshort=="PET"){ 
      
      vshort<-"pet" 
      
    };vshort 
    
    
    if(vshort=="Deficit"){#change case of short name from upper to lower case 
      
      vshort<-"deficit" 
      
    };vshort 
    
    
    if(vshort=="AET"){ 
      
      vshort<-"aet" 
      
    };vshort 
    
    
    
    for(yr in c(future_start:future_end)){# for each climate variable loop across the year.  allows users to select range if not interested in all data 
      
      #single variable single year monthly time series with variable and year specified by user 
      
      leap <- lubridate::leap_year(yr) 
      if(leap == TRUE){
        day <- 16
      } else {
        day <- 17
      }
      
      data_url<- paste("http://www.yellowstone.solutions/thredds/ncss/daily_or_monthly/gcm/",rcp,"/",m,"/V_1_5_",yr,"_",m,"_",rcp, "_",climvar,".nc4?var=",vshort,"&latitude=",lat,"&longitude=",lon,"&time_start=",yr,"-01-16T05%3A14%3A31.916Z&time_end=",yr,"-12-",day,"T00%3A34%3A14.059Z&accept=csv_file",sep ="")

      
      holder <-data.frame(fread(data_url, 
                                verbose=FALSE, 
                                showProgress = FALSE,
      ))#temporary holder for subsets downloaded from cloud 
      
      colnames(holder) <- c("time", "latitude", "longitude", paste(climvar))
      
      mydat<-rbind(mydat, holder)#file that grows by adding each chunk downloaded from cloud 
      
      date <- mydat$time
      
    }#end loop across years 
    
    mydat2<-cbind(mydat2,mydat[,4])#append just the water balance data from each downloaded chunk 
    
    mydat<-NULL#reset this variable so it can accodomate a new column name given the new water balance variable it's extracting at each loop cycle 
    
  }#end loop across climate variables 
    
  if(rcp == "rcp45"){
    
    mydat3 <- NULL 
    
  mydat3<-cbind(date,holder[,2:3],mydat2) #join the data with metadat including date, lat, long 
  
  }# close if for rcp45 
    
if(rcp == "rcp85"){
      
      mydat4 <- NULL
      
      mydat4 <- cbind(date,holder[,2:3],mydat2) #join the data with metadat including date, lat, long 
      
    } #close if rcp85
    
  } #close rcp
  
  mydat5 <- cbind(mydat3,mydat4[,4:5]) #join the data with metadata including date, lat, long
  
  colnames(mydat5)[] <- c("date", "lat","lon","deficit_monthly_45", "aet_monthly_45", "deficit_monthly_85", "aet_monthly_85") 
  
  divide.by.10 <- function(x, na.rm = FALSE) {
    x/10
  }
  
  mydat6 <- mydat5 %>% 
    mutate(lat = as.character(lat),
           lon = as.character(lon)) %>% 
    mutate_if(is.numeric, divide.by.10) %>% 
    mutate(model = m)
  
  mydat7 <- rbind(mydat7, mydat6)
  
}# end loop across different climate projections

  write_csv(mydat7, here::here("sites", 
                               site, 
                               "raw_data", 
                               paste("lat",lat,"lon",lon, sep = "_"), 
                               "future_aet_d.csv")) #default is a space, sep = "" removes space
beep(1)

# here::here allows you to choose a folder in your working directory to save to
# here::here("folder I want to save to (this has to be made in your working directory before you save it)", "subfolder", "subfolder ( subfolders can be as numerous you want them to be, always separated by a commma)", "last thing in the list is the name of the object I'm saving")


```


